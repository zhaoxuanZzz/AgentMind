# 特性规范：聊天界面增强

**特性分支**：`002-chat-ui-enhancement`  
**创建日期**：2026-01-26  
**状态**：草稿  
**输入**：用户描述："1、重新设计前后端chat交互格式,确保兼容thinking,tools,plan等不同的样式展示。前端也有需要用ant-design-x组件来渲染不同的样式 2、新增plan模式,对话框发送按钮右边可以开关plan模式 3、新增选择\"角色预设\"的下拉框,用户可以将agent设置成指定的角色"

## 用户场景和测试 *（必需）*

### 用户故事 1 - 多样化消息类型显示 (优先级: P1)

作为用户，我希望在聊天界面中清晰地看到AI的不同思考和执行过程（思考内容、工具调用、计划步骤等），以便更好地理解AI如何处理我的请求并获得更透明的交互体验。

**为什么是此优先级**：这是核心功能，直接影响用户体验和系统可用性。没有适当的消息格式支持，用户将无法有效地使用系统的高级功能。

**独立测试**：可以通过发送触发不同消息类型的提示（思考型问题、需要工具的问题等）来完全测试，并验证每种类型都能正确渲染。

**验收场景**：

1. **给定** 用户在聊天界面中，**当** AI生成包含思考过程的回复，**那么** 思考内容应以特殊样式（如不同背景色或图标）显示，与普通回复内容区分
2. **给定** 用户在聊天界面中，**当** AI调用工具（如计算器、搜索等），**那么** 工具调用信息应清晰显示工具名称、参数和返回结果
3. **给定** 用户在聊天界面中，**当** AI生成计划步骤，**那么** 计划应以结构化列表形式展示，每个步骤清晰可辨
4. **给定** 用户在聊天界面中，**当** 消息包含多种类型内容（思考+工具+回复），**那么** 各部分应按逻辑顺序正确渲染，不发生混乱或重叠
5. **给定** 前后端交互，**当** 后端发送包含特殊类型的消息，**那么** 前端应能正确解析并渲染所有类型

---

### 用户故事 2 - 计划模式切换 (优先级: P2)

作为用户，我希望能够切换"计划模式"，让AI在执行任务前先制定详细计划，以便对于复杂任务能够获得更结构化和可预测的执行过程。

**为什么是此优先级**：这是增强功能，为高级用户提供更多控制选项。虽然有价值，但不是基础功能。

**独立测试**：可以通过开启/关闭计划模式开关，然后发送相同的复杂问题，验证AI在两种模式下的不同行为。

**验收场景**：

1. **给定** 用户在聊天界面，**当** 用户点击发送按钮旁的计划模式切换开关，**那么** 开关状态应立即更新并显示当前模式（开启/关闭）
2. **给定** 计划模式已开启，**当** 用户发送消息，**那么** 请求应包含计划模式标识发送到后端
3. **给定** 计划模式已开启，**当** AI处理请求，**那么** AI应先生成任务计划，并以计划格式展示
4. **给定** 计划模式已关闭，**当** 用户发送消息，**那么** AI应按常规方式直接回复，不生成计划
5. **给定** 用户切换计划模式，**当** 刷新页面或重新进入聊天，**那么** 计划模式状态应保持用户最后的选择

---

### 用户故事 3 - 角色预设选择 (优先级: P2)

作为用户，我希望能从预设角色列表中选择AI的角色（如"编程助手"、"文案写作"、"数据分析师"等），以便快速获得针对特定场景优化的AI行为。

**为什么是此优先级**：这是用户体验优化功能，可以显著提升特定场景下的使用效率，但不影响核心聊天功能。

**独立测试**：可以通过选择不同角色预设，发送相同问题，验证AI回复是否符合所选角色的特征。

**验收场景**：

1. **给定** 用户在聊天界面，**当** 用户点击角色预设下拉框，**那么** 应显示所有可用的角色选项列表
2. **给定** 角色预设下拉框已展开，**当** 用户选择一个角色（如"编程助手"），**那么** 下拉框应显示选中的角色名称，并关闭下拉列表
3. **给定** 用户已选择角色，**当** 用户发送消息，**那么** 请求应包含所选角色信息发送到后端
4. **给定** 用户已选择角色，**当** AI回复，**那么** 回复应符合该角色的特点和行为模式
5. **给定** 用户选择新角色，**当** 切换到另一个对话，**那么** 该对话应使用新选择的角色，而其他对话保持各自的角色设置（混合模式：全局默认角色+对话级覆盖）
6. **给定** 用户关闭并重新打开应用，**当** 进入聊天界面，**那么** 应显示全局默认角色，各对话保持其特定的角色覆盖
7. **给定** 用户在某个对话中更改角色，**当** 创建新对话，**那么** 新对话应使用全局默认角色，而非上个对话的角色

---

### 边界情况

- 当后端返回格式错误或不完整的消息类型时，前端应显示错误提示而不是崩溃
- 当网络延迟导致消息部分到达时，前端应能处理流式数据并逐步渲染
- 当用户快速切换计划模式时，应取消进行中的请求或确保请求使用正确的模式
- 当角色预设列表为空或加载失败时，应显示默认选项或友好的错误提示
- 当用户在计划模式下发送非常简单的问题时，后端应智能判断问题复杂度，对于简单问题（如问候、简单计算）跳过计划生成，直接回答
- 当消息包含未知类型时，前端应以默认方式渲染，保持向后兼容性

## 需求 *（必需）*

### 功能需求

#### 消息格式和渲染

- **FR-001**：系统必须支持至少以下消息类型：普通文本、思考过程（thinking）、工具调用（tools）、计划步骤（plan）
- **FR-002**：前端必须使用ant-design-x组件渲染不同类型的消息，每种类型有独特的视觉样式
- **FR-003**：后端必须在响应中明确标识消息类型，使前端能准确识别和渲染
- **FR-004**：前后端必须使用统一的消息格式规范，包括类型标识符、内容结构和元数据
- **FR-005**：系统必须支持流式传输，允许消息逐步渲染而不需要等待完整响应

#### 计划模式

- **FR-006**：用户界面必须在发送按钮旁提供计划模式切换控件（如开关、复选框）
- **FR-007**：切换计划模式时，系统必须保存用户的偏好设置
- **FR-008**：开启计划模式时，发送到后端的请求必须包含计划模式标识
- **FR-009**：后端在计划模式下必须智能判断问题复杂度，对复杂任务生成计划，对简单问题直接回答
- **FR-010**：计划内容必须以结构化格式返回（如步骤编号、描述、预估结果等）
- **FR-018**：后端必须实现问题复杂度判断逻辑，能区分简单问题（如问候、单步计算）和复杂任务（如多步骤开发、分析任务）

#### 角色预设

- **FR-011**：用户界面必须提供角色预设选择下拉框
- **FR-012**：系统必须提供以下预定义角色选项：软件工程师、产品经理、市场营销、翻译专家、研究助理
- **FR-013**：系统必须支持全局默认角色设置，并允许为每个对话单独覆盖角色选择
- **FR-014**：发送到后端的请求必须包含当前对话选择的角色信息（对话特定角色或全局默认角色）
- **FR-015**：后端必须根据角色预设调整系统提示词或行为参数
- **FR-016**：系统必须提供默认角色选项（如"软件工程师"），用于未选择时或首次使用
- **FR-017**：系统必须持久化保存全局默认角色和各对话的角色覆盖设置

### 关键实体

- **消息（Message）**：表示聊天中的单条消息，包含类型（type）、内容（content）、发送者（sender）、时间戳（timestamp）、元数据（metadata）
- **消息类型（MessageType）**：枚举值，包括text（普通文本）、thinking（思考过程）、tool（工具调用）、plan（计划）、system（系统消息）
- **角色预设（RolePreset）**：表示预定义的AI角色，包含名称（name）、描述（description）、系统提示词（systemPrompt）、配置参数（config）。预定义角色包括：软件工程师、产品经理、市场营销、翻译专家、研究助理
- **会话配置（ConversationConfig）**：表示对话的配置，包含计划模式开关（planModeEnabled）、选择的角色（selectedRole，可为null表示使用全局默认）、其他设置
- **全局设置（GlobalSettings）**：表示跨对话的全局配置，包含默认角色（defaultRole）、默认计划模式（defaultPlanMode）等

## 成功标准 *（必需）*

### 可衡量的成果

- **SC-001**：用户能够在聊天界面中清晰区分至少4种不同的消息类型（文本、思考、工具、计划），无视觉混淆
- **SC-002**：切换计划模式的响应时间少于500毫秒，用户体验流畅
- **SC-003**：90%的用户能在首次使用时无需指导即找到并使用计划模式和角色预设功能
- **SC-004**：前后端消息格式兼容性达到100%，不出现解析错误或渲染失败
- **SC-005**：在计划模式下，复杂任务的用户满意度提升30%（通过生成结构化计划提高可预测性）
- **SC-006**：角色预设功能使特定场景任务（如代码生成、文案写作）的完成效率提升20%
- **SC-007**：系统在处理包含多种消息类型的复杂回复时，渲染延迟不超过100毫秒（从数据接收到显示）

## 假设

- 后端已具备或将开发生成不同类型内容（思考、工具调用、计划）的能力
- ant-design-x组件库提供足够的灵活性来实现所需的消息渲染样式
- 用户主要在桌面浏览器使用聊天界面，但设计应考虑移动端兼容性
- 角色预设将由管理员或开发者配置，初期不需要用户自定义角色功能
- 计划模式可能增加响应时间，但用户接受这种权衡以获得更结构化的输出
- 消息类型的扩展性已考虑，未来可能添加更多类型（如图像、文件等）
- 后端具备判断问题复杂度的能力（可通过启发式规则或简单的AI分类实现）
- 混合角色模式（全局+对话级）的状态管理可以通过现有的数据存储机制实现
