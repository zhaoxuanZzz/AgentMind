openapi: 3.0.3
info:
  title: Chat Stream API v2
  description: 增强的聊天流式API，支持多种消息类型（thinking、tool、plan、text）
  version: 2.0.0

paths:
  /api/chat/stream-v2:
    post:
      summary: 流式聊天（v2增强版）
      description: |
        发送消息并接收流式响应。支持以下功能：
        - 多种消息类型（thinking、tool、plan、text、system）
        - 计划模式（先制定计划再执行）
        - 角色预设（自定义AI行为）
        - 复杂度智能判断
      operationId: chatStreamV2
      tags:
        - Chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequestV2'
            examples:
              basic:
                summary: 基本对话
                value:
                  message: "解释一下Python装饰器"
                  conversation_id: null
              with_plan_mode:
                summary: 使用计划模式
                value:
                  message: "帮我设计一个任务管理系统"
                  conversation_id: null
                  plan_mode: true
                  role_id: "software_engineer"
              with_role:
                summary: 指定角色
                value:
                  message: "如何提高产品用户留存率？"
                  role_id: "product_manager"
      responses:
        '200':
          description: 成功，返回SSE流
          content:
            text/event-stream:
              schema:
                type: string
                description: Server-Sent Events流，每个event包含一个MessageChunk的JSON
              examples:
                thinking_then_answer:
                  summary: 思考过程 + 最终答案
                  value: |
                    data: {"type":"conversation_id","conversation_id":123}
                    
                    data: {"type":"thinking","content":"我需要解释装饰器的概念...","timestamp":"2026-01-26T10:00:00Z"}
                    
                    data: {"type":"text","content":"Python装饰器是一种设计模式...","timestamp":"2026-01-26T10:00:01Z"}
                    
                    data: {"type":"done","conversation_id":123,"message_id":456}
                    
                plan_mode_example:
                  summary: 计划模式示例
                  value: |
                    data: {"type":"plan","step_number":1,"description":"分析系统需求","status":"in_progress"}
                    
                    data: {"type":"plan","step_number":1,"description":"分析系统需求","status":"completed","result":"识别出用户管理、任务CRUD等核心需求"}
                    
                    data: {"type":"plan","step_number":2,"description":"设计数据模型","status":"in_progress"}
                    
                    data: {"type":"text","content":"根据计划完成的设计..."}
                    
                    data: {"type":"done"}
                    
                tool_call_example:
                  summary: 工具调用示例
                  value: |
                    data: {"type":"thinking","content":"我需要搜索最新的信息..."}
                    
                    data: {"type":"tool","tool_name":"web_search","tool_input":{"query":"Python 3.12新特性"},"status":"running"}
                    
                    data: {"type":"tool","tool_name":"web_search","tool_input":{"query":"Python 3.12新特性"},"tool_output":"Python 3.12引入了...","status":"completed"}
                    
                    data: {"type":"text","content":"根据搜索结果..."}
                    
                    data: {"type":"done"}
                    
        '400':
          description: 请求参数错误
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: 服务器错误
          content:
            text/event-stream:
              schema:
                type: string
              example: |
                data: {"type":"error","message":"Internal server error","code":"INTERNAL_ERROR"}
                

components:
  schemas:
    ChatRequestV2:
      type: object
      required:
        - message
      properties:
        message:
          type: string
          description: 用户消息内容
          minLength: 1
          example: "解释一下Python装饰器"
        conversation_id:
          type: integer
          nullable: true
          description: 对话ID，null表示创建新对话
          example: 123
        role_id:
          type: string
          nullable: true
          description: 角色预设ID，覆盖会话配置
          enum:
            - software_engineer
            - product_manager
            - marketing
            - translator
            - research_assistant
          example: "software_engineer"
        plan_mode:
          type: boolean
          nullable: true
          description: 是否启用计划模式，null表示使用会话配置或全局默认
          example: true
        use_knowledge_base:
          type: string
          nullable: true
          description: 知识库名称（向后兼容）
          example: "prompts"
        search_provider:
          type: string
          nullable: true
          description: 搜索提供商
          enum: [tavily, baidu]
          example: "tavily"
        deep_reasoning:
          type: boolean
          description: 是否启用深度推理（向后兼容）
          default: false
        llm_config:
          type: object
          nullable: true
          description: LLM配置
          properties:
            provider:
              type: string
              example: "dashscope"
            model:
              type: string
              example: "qwen3-vl-plus"

    MessageChunk:
      type: object
      required:
        - type
      properties:
        type:
          type: string
          enum: [text, thinking, tool, plan, system, conversation_id, done, error]
          description: 消息块类型
        timestamp:
          type: string
          format: date-time
          description: 时间戳
      discriminator:
        propertyName: type
        mapping:
          text: '#/components/schemas/TextChunk'
          thinking: '#/components/schemas/ThinkingChunk'
          tool: '#/components/schemas/ToolChunk'
          plan: '#/components/schemas/PlanChunk'
          system: '#/components/schemas/SystemChunk'
          conversation_id: '#/components/schemas/ConversationIdChunk'
          done: '#/components/schemas/DoneChunk'
          error: '#/components/schemas/ErrorChunk'

    TextChunk:
      allOf:
        - $ref: '#/components/schemas/MessageChunk'
        - type: object
          required:
            - content
          properties:
            content:
              type: string
              description: 文本内容
              example: "Python装饰器是一种设计模式..."

    ThinkingChunk:
      allOf:
        - $ref: '#/components/schemas/MessageChunk'
        - type: object
          required:
            - content
          properties:
            content:
              type: string
              description: 思考过程内容
              example: "我需要先解释装饰器的基本概念..."
            reasoning_step:
              type: integer
              nullable: true
              description: 推理步骤编号
              example: 1

    ToolChunk:
      allOf:
        - $ref: '#/components/schemas/MessageChunk'
        - type: object
          required:
            - tool_name
            - tool_input
            - status
          properties:
            tool_name:
              type: string
              description: 工具名称
              example: "web_search"
            tool_input:
              type: object
              description: 工具输入参数
              additionalProperties: true
              example: {"query": "Python decorators"}
            tool_output:
              type: string
              nullable: true
              description: 工具输出结果
              example: "搜索结果：装饰器允许..."
            status:
              type: string
              enum: [pending, running, completed, failed]
              description: 执行状态
              example: "completed"
            error:
              type: string
              nullable: true
              description: 错误信息（如果失败）
              example: null

    PlanChunk:
      allOf:
        - $ref: '#/components/schemas/MessageChunk'
        - type: object
          required:
            - step_number
            - description
            - status
          properties:
            step_number:
              type: integer
              minimum: 1
              description: 步骤编号
              example: 1
            description:
              type: string
              description: 步骤描述
              example: "分析系统需求"
            status:
              type: string
              enum: [pending, in_progress, completed, failed]
              description: 步骤状态
              example: "completed"
            result:
              type: string
              nullable: true
              description: 步骤执行结果
              example: "识别出5个核心功能模块"
            substeps:
              type: array
              items:
                type: string
              nullable: true
              description: 子步骤列表
              example: ["用户认证", "任务CRUD", "权限管理"]

    SystemChunk:
      allOf:
        - $ref: '#/components/schemas/MessageChunk'
        - type: object
          required:
            - content
          properties:
            content:
              type: string
              description: 系统消息内容
              example: "已切换到软件工程师角色"
            level:
              type: string
              enum: [info, warning, error]
              default: info
              description: 消息级别
              example: "info"

    ConversationIdChunk:
      allOf:
        - $ref: '#/components/schemas/MessageChunk'
        - type: object
          required:
            - conversation_id
          properties:
            conversation_id:
              type: integer
              description: 创建的对话ID
              example: 123

    DoneChunk:
      allOf:
        - $ref: '#/components/schemas/MessageChunk'
        - type: object
          properties:
            conversation_id:
              type: integer
              description: 对话ID
              example: 123
            message_id:
              type: integer
              description: 保存的消息ID
              example: 456

    ErrorChunk:
      allOf:
        - $ref: '#/components/schemas/MessageChunk'
        - type: object
          required:
            - message
          properties:
            message:
              type: string
              description: 错误信息
              example: "Failed to process request"
            code:
              type: string
              nullable: true
              description: 错误代码
              example: "INVALID_INPUT"

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: 错误详情
          example: "Invalid request parameters"
